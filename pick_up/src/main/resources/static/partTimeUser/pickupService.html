<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>æµè§ˆå™¨ç²¾ç¡®å®šä½</title>
    <style>
        /* æ–°å¢å¸ƒå±€æ ·å¼ */
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        #map-container {
            flex: 1;
            height: 50vh;
            min-height: 300px;
        }
        /* å®šä½ä¿¡æ¯æ¡†æ ·å¼ï¼ˆä¿æŒä¸åŸå›¾ä¸€è‡´ï¼‰ */
        .info {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 400px;
            background: rgba(255,255,255,0.95);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 999;
            padding: 15px;
            border: 1px solid #e0e0e0;
        }

        /* ä¸‹åŠéƒ¨å®¹å™¨æ ·å¼ï¼ˆä¿æŒç•™ç©ºï¼‰ */
        #info-container {
            height: 40vh;
            padding: 20px;
            background: white;
            border-top: 2px solid #eee;
            overflow-y: auto;
        }

        .orders-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .orders-table th {
            background: #f8f9fa;
            padding: 12px 15px;
            text-align: left;
            border-bottom: 2px solid #e4e4e4;
            color: #666;
        }

        .orders-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        .status-tag {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        /* ä¿¡æ¯æ¡†å†…å®¹æ ·å¼ */
        .info-item {
            margin: 8px 0;
            font-size: 14px;
            line-height: 1.5;
        }

        .label {
            color: #666;
            display: inline-block;
            width: 80px;
            margin-right: 8px;
        }

        .value {
            color: #333;
            font-weight: 500;
        }

        /* åˆå§‹éšè—ä¿¡æ¯æ¡† */
        #location-info {
            display: none;
        }

        .action-button {
            padding: 4px 12px;
            border: 1px solid #ff4d4f;
            border-radius: 4px;
            background: white;
            color: #ff4d4f;
            cursor: pointer;
            margin-left: 8px;
            transition: all 0.3s;
        }

        .action-button:hover {
            background: #ff4d4f;
            color: white;
        }

        .action-button:disabled {
            border-color: #d9d9d9;
            color: #d9d9d9;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
<!-- ä¸ŠåŠéƒ¨åˆ†ï¼šåœ°å›¾å®¹å™¨ -->

<!-- åœ¨bodyå†…æ·»åŠ åŠ è½½æç¤º -->
<div id="loading" style="
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%,-50%);
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 15px;
    border-radius: 5px;
    display: none;
">
    <i class="fa fa-spinner fa-spin"></i> å®šä½ä¸­...
</div>

<script>
    // ä¿®æ”¹åœ°å›¾å®šä½éƒ¨åˆ†ä»£ç 
    function initMap() {
        showLoading(); // æ–°å¢

        AMap.plugin('AMap.Geolocation', function() {
            var geolocation = new AMap.Geolocation({
                enableHighAccuracy: true,
                timeout: 10000
            });

            geolocation.getCurrentPosition(function(status, result){
                hideLoading(); // æ–°å¢

                if(status == 'complete'){
                    onComplete(result)
                } else {
                    onError(result)
                }
            });
        });
    }

    function showLoading() {
        document.getElementById('loading').style.display = 'block';
    }

    function hideLoading() {
        document.getElementById('loading').style.display = 'none';
    }
</script>

<div id="map-container">
    <div id="container" style="width:100%;height:100%;"></div>
</div>
<!-- æ–°å¢å®šä½ä¿¡æ¯å±•ç¤ºå®¹å™¨ -->
<div class="info" id="location-info">
    <h4 style="margin:0 0 10px 0;color:#333;">å®šä½ä¿¡æ¯</h4>
    <div id="location-details"></div>
</div>

<!-- ä¸‹åŠéƒ¨åˆ†ï¼šä¿¡æ¯å±•ç¤º -->
<div id="info-container">
    <h3 style="margin-bottom:15px;">å¿«é€’ä»£å–ç”³è¯·åˆ—è¡¨</h3>
    <table class="orders-table">
        <thead>
        <tr>
            <th>ç”³è¯·ID</th>
            <th>ç”¨æˆ·ID</th>
            <th>åŒ…è£¹ID</th>
            <th>å–ä»¶æ—¶é—´</th>
            <th>å–ä»¶åœ°ç‚¹</th>
            <th>çŠ¶æ€</th>
        </tr>
        </thead>
        <tbody id="orders-body">
        <tr>
            <td colspan="6" style="text-align:center;padding:30px;">æ•°æ®åŠ è½½ä¸­...</td>
        </tr>
        </tbody>
    </table>
</div>
<script>
    // ========== è®¢å•æ•°æ®è·å– ==========
    // ä¿®æ”¹è®¢å•æ•°æ®è·å–é€»è¾‘
    fetch('/pickup_SpringBoot/partTimeUser/getAllApplications')
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('orders-body');
            tbody.innerHTML = data.map(item => `
            <tr>
                <td>${item.application_id}</td>
                <td>${item.user_id}</td>
                <td>${item.package_id}</td>
                <td>${formatDateTime(item.pickup_time)}</td>
                <td>${item.pickup_location}</td>
                <td>
                    <span class="status-tag ${getStatusClass(item.status)}">
                        ${item.status}
                    </span>
                    ${item.status === 'å¾…å¤„ç†' ?
                `<button class="action-button"
                                onclick="handleAcceptOrder('${item.application_id}')">
                                ç«‹å³æ¥å•
                            </button>` :
                '<span style="color:#999;">å·²æ¥å•</span>'}
                </td>
            </tr>
        `).join('');
        });

    // æ–°å¢æ—¶é—´æ ¼å¼åŒ–å‡½æ•°
    function formatDateTime(isoString) {
        const date = new Date(isoString);
        return date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        }).replace(/\//g, '-');
    }

    function getStatusClass(status) {
        return status === 'å¾…å¤„ç†' ? 'status-pending' : 'status-completed';
    }

    // æ¥å•å¤„ç†å‡½æ•°
    async function handleAcceptOrder(applicationId) {
        const button = event.target;
        button.disabled = true;
        button.innerHTML = '<i class="fa fa-spinner fa-spin"></i> å¤„ç†ä¸­';

        try {
            // æ¨¡æ‹ŸAPIè°ƒç”¨ï¼Œå®é™…éœ€è¦æ›¿æ¢ä¸ºçœŸå®æ¥å£
            const response = await fetch(`/pickup_SpringBoot/partTimeUser/acceptOrder/${applicationId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                }
            });
            const responseText = await response.text();
            if (responseText === "æ¥å•æˆåŠŸ") {
                alert('æ¥å•æˆåŠŸï¼');
                // æ›´æ–°é¡µé¢çŠ¶æ€
                button.parentElement.innerHTML = `
                    <span class="status-tag status-completed">
                        å·²æ¥å•
                    </span>
                    <span style="color:#999;margin-left:8px;">è¿›è¡Œä¸­</span>
                `;
            } else {
                throw new Error('æ¥å•å¤±è´¥');
            }
        } catch (error) {
            alert(error.message);
            button.disabled = false;
            button.innerHTML = 'ç«‹å³æ¥å•';
        }
    }

    /* ========== å·²æœ‰çš„åœ°å›¾ä»£ç å®Œå…¨ä¿ç•™ ========== */
</script>

<script type="text/javascript">
    window._AMapSecurityConfig = {
        securityJsCode:'f7e7f4ffdf8602e536f4381f9e90e587',
    }
</script>
<script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=3402d0500577e98166c8d743057f82cf"></script>
<script type="text/javascript">
    var map = new AMap.Map('container', {
        zoom:12,
        resizeEnable: true
    });

    AMap.plugin('AMap.Geolocation', function() {
        var geolocation = new AMap.Geolocation({
            enableHighAccuracy: true,
            timeout: 10000,
            buttonPosition:'RB',
            buttonOffset: new AMap.Pixel(10, 20),
            zoomToAccuracy: true,
            needAddress: true,
        });
        map.addControl(geolocation);
        geolocation.getCurrentPosition(function(status,result){
            if(status=='complete'){
                onComplete(result)
                console.log(result);
                console.log(position_ie);
            }else{
                onError(result)
            }
        });
    });

    function onComplete(data) {
        // ç¡®ä¿ä¿¡æ¯å®¹å™¨å¯è§
        document.getElementById('location-info').style.display = 'block';

        // ç»“æ„åŒ–å±•ç¤ºå®šä½ä¿¡æ¯
        const detailsHtml = `
        <div class="info-item">
            <span class="label">ğŸ“ åæ ‡ï¼š</span>
            <span class="value">${data.position.lng.toFixed(6)}, ${data.position.lat.toFixed(6)}</span>
        </div>
        <div class="info-item">
            <span class="label">ğŸ“¡ ç±»å‹ï¼š</span>
            <span class="value">${data.location_type}</span>
        </div>
        <div class="info-item">
            <span class="label">ğŸ  åœ°å€ï¼š</span>
            <span class="value">${data.formattedAddress}</span>
        </div>
        <div class="info-item">
            <span class="label">ğŸ“ ç²¾åº¦ï¼š</span>
            <span class="value">${data.accuracy || '--'} ç±³</span>
        </div>
        <div class="info-item">
            <span class="label">ğŸ§­ åç§»ï¼š</span>
            <span class="value">${data.isConverted ? 'å·²çº å' : 'åŸå§‹æ•°æ®'}</span>
        </div>
    `;

        document.getElementById('location-details').innerHTML = detailsHtml;
    }

    function onError(data) {
        document.getElementById('status').innerHTML='å®šä½å¤±è´¥'
        document.getElementById('result').innerHTML = 'å¤±è´¥åŸå› æ’æŸ¥ä¿¡æ¯:'+data.message;
    }
</script>
</body>
</html>